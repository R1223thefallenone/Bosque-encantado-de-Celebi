<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pok√©mon Tracker ‚Äî PWA (Perfecci√≥n) con 151</title>
  <meta name="description" content="Contador de Vidas y EXP estilo Yoshi's Island. Lista de Kanto (151) + evoluci√≥n din√°mica + reseteo en etapa seleccionada" />
  
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    /* --- Est√©tica Pok√©dex Limpia (acuarela pastel) --- */
    :root{
      --bg:#f8f4ed; /* Fondo Principal */
      --card:#fffcf8; /* Fondo de Tarjeta y Lista */
      --accent:#9b59b6; /* Morado (General) */
      --exp:#7a47a1; /* Morado Oscuro (EXP Circle) */
      --heart:#ff5c7c; /* Rosa (Coraz√≥n Fuerte) */
      --ink:#3b2f2f; /* Tinta Principal (NEGRO) */
      --muted:#7b6f6f; /* Texto Secundario */
      --active-shadow: 0 4px 10px rgba(59,47,47,0.08); 
      --shadow: 0 10px 25px rgba(59,47,47,0.1); /* Sombra m√°s limpia */
      --radius:20px;
      --gutter:16px;
      font-family: 'Nunito', 'Segoe UI', Roboto, -apple-system, 'Helvetica Neue', Arial;
      font-weight: 700;
      scroll-behavior: smooth;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#fff);color:var(--ink);}
    .app{max-width:1050px;margin:30px auto;padding:16px;}
    
    /* --- Header y Layout --- */
    header{display:flex;align-items:center;gap:14px;padding:10px 8px; margin-bottom: 20px;}
    .logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(180deg,#fff,#f5e6d0);display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);font-size:30px; font-weight:900; color: #555;}
    .title{font-weight:900;font-size:22px;letter-spacing:0.5px}
    .panel{display:grid;grid-template-columns:350px 1fr;gap:30px;}

    /* --- Lista Izquierda (List) --- */
    .list{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow);height:75vh;overflow-y:auto; border: 1px solid rgba(0,0,0,0.05);}
    .search{display:flex;gap:10px;margin-bottom:14px;position:sticky;top:0;background:var(--card);padding:8px 0;z-index:10;box-shadow:0 4px 6px -6px rgba(0,0,0,0.1)}
    .search input, .search select{flex:1;padding:12px;border-radius:14px;border:2px solid #e7dfd1;background:#fffaf3;outline:none;font-size:15px;font-weight:700}
    
    .poke-card{display:flex;align-items:center;gap:14px;padding:12px;border-radius:16px;margin-bottom:10px;cursor:pointer;background:linear-gradient(180deg,#ffffff,#fefcf8);box-shadow:0 4px 10px rgba(0,0,0,0.04);transition:transform .15s, box-shadow .15s, border .15s}
    .poke-card:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,0.08)}
    .mini-sprite{width:64px;height:64px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted);background-color: #f7f2ed; border: 1px solid rgba(0,0,0,0.05); overflow: hidden; flex-shrink: 0;}
    .mini-sprite img { height: 100%; width: 100%; object-fit: contain; }
    .meta{display:flex;flex-direction:column}
    .meta strong{font-weight:900;font-size:17px; margin-bottom: 2px;}
    .meta small{color:var(--muted);font-weight:600;font-size: 13px;}

    /* --- Ficha Derecha (Sheet) | CARD LAYOUT --- */
    .sheet{
        background:var(--card);
        padding:20px; 
        border-radius:var(--radius);
        box-shadow:var(--shadow);
        height:75vh;
        display:flex;
        flex-direction:column;
        border: 1px solid rgba(0,0,0,0.05);
        position: relative; 
        overflow: hidden; 
    }
    
    /* Contenedor principal del Sprite */
    .sprite-area-card{
        flex-grow: 1; 
        display:flex;
        flex-direction: column; 
        align-items:center;
        justify-content:flex-start; 
        background:#fdf9f4;
        border-radius:16px;
        position: relative; 
        border:2px solid rgba(0,0,0,0.03);
        padding-top: 90px; 
        padding-bottom: 20px;
        min-height: 400px; 
    }

    /* Sprite Contenedor (Optimizaci√≥n de Espacio) */
    .big-sprite{
        width: 100%; 
        height: 100%; 
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: center; 
        z-index: 1;
        overflow: hidden;
        top: -10%; 
    }
    .big-sprite img { 
        height: 85%; 
        width: auto; 
        object-fit: contain; 
        image-rendering: pixelated; 
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
    }

    /* Capa superior de Overlays */
    .overlay-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 5; 
        padding: 20px;
        pointer-events: none; 
        display: flex;
        flex-direction: column;
    }
    
    /* Header compacto (Vidas/EXP) */
    .compact-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:16px;
        width: 100%;
        pointer-events: all;
    }
    .exp-group, .life-group {
        display:flex; 
        align-items:center; 
        gap:6px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
        padding: 8px;
        border-radius: 16px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
    }
    
    /* C√≠rculos de Stats */
    .stat-circle{
        width:56px; 
        height:56px;
        border-radius:999px;
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        color:white;
        font-weight:900;
        box-shadow:0 6px 14px rgba(0,0,0,0.15);
        border:3px solid rgba(255,255,255,0.25);
        pointer-events: none; 
    }
    .stat-circle small{font-size:10px;opacity:0.9;font-weight:700}
    .stat-circle .num{font-size:22px}
    .exp-circle{background:linear-gradient(180deg,#b487cc,var(--exp));box-shadow:0 6px 14px rgba(122,71,160,0.3);}
    .heart{background:linear-gradient(180deg,#ff809a,var(--heart));box-shadow:0 6px 14px rgba(255,80,110,0.3); font-size:24px}
    .heart-icon{font-size: 16px; margin-bottom: 4px; opacity: 0.9;}

    /* Contenedor Inferior (Estilo, Descripci√≥n, Nombre) */
    .bottom-overlay{
        margin-top: auto; 
        width: 100%;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 10px;
    }

    .style-badge-compact{
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px; 
        border-radius: 16px;
        background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,240,255,0.95));
        backdrop-filter: blur(5px);
        border: 2px solid rgba(0,0,0,0.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-size: 16px; 
    }
    .style-badge-compact .left{
        display: flex;
        align-items: center;
        gap: 8px; 
        font-weight: 900;
    }
    .poke-title-card {
        font-weight:900; 
        font-size:30px; 
        text-align: left;
        color: var(--ink); 
        margin-top: 4px;
        pointer-events: all; 
    }

    /* Descripci√≥n de Estilo (Transparente) */
    .style-desc{
        padding:12px;
        border-radius:14px;
        background:rgba(255,255,255,0.08); 
        backdrop-filter: blur(15px); 
        border:2px solid rgba(255,255,255,0.03); 
        box-shadow:inset 0 0 0 1px rgba(0,0,0,0.02); 
        font-size:13px; 
        font-weight:700; 
        color:var(--ink);
        pointer-events: none;
        text-shadow: 0 1px 1px rgba(255,255,255,0.5); 
        line-height: 1.5;
    }
    .style-desc strong{font-weight:900; font-size: 14px;}
    .style-desc p{margin-top:6px; font-weight: 600}


    /* --- POSICIONES DE CONTROLES (¬°AJUSTES FINALES PARA PERFECCI√ìN!) --- */

    /* NUEVO CONTENEDOR FLEXIBLE PARA LA FILA SUPERIOR */
    .top-controls-row {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px; /* Espacio debajo de la fila */
        pointer-events: all;
    }
    
    /* 1. BARRA DE EXP (entre EXP y Vidas) - CON BORDE NEGRO */
    .card-exp-bar-position {
        flex-grow: 1; /* Ocupa el espacio central */
        max-width: 40%; 
        margin: 0 15px; 
    }
    .exp-bar-wrapper{
        width: 100%;
        height:10px; 
        background: rgba(155, 89, 182, 0.2); 
        padding: 0; 
        border-radius: 8px;
        box-shadow: none;
        /* BORDE NEGRO SOLICITADO */
        border: 2px solid var(--ink); 
    }
    .exp-bar{height:100%; background:linear-gradient(90deg, #9b59b6, #7a47a1); transition: width 0.3s ease-out; border-radius:8px;}

    /* 2. GRUPO DE BOTONES VERTICALES (DADO + RESET) */
    .roll-button-position, .reset-button-position {
        /* Ocultamos las posiciones anteriores para usar el nuevo grupo */
        display: none; 
    }
    
    .vertical-button-group {
        position: absolute;
        right: 20px;
        top: 38%; /* CENTRAMOS VERTICALMENTE AL 40% (M√ÅS ARRIBA) */
        transform: translateY(-45%); /* Ajuste para un centrado vertical perfecto */
        z-index: 10;
        pointer-events: all;
        display: flex;
        flex-direction: column; /* Apilamiento vertical */
        align-items: center;
        gap: 5px; /* Mantenemos el espacio reducido */
    }

    #rollBtn {
        padding:10px 18px; 
        border-radius:12px;
        font-size:16px;
        font-weight:800;
        background:#3b2f2f; /* Color NEGRO */
        color:white;
        box-shadow:0 4px 10px rgba(59,47,47,0.3);
        border: none;
        cursor: pointer;
        transition: transform .15s, box-shadow .15s; 
    }
    #rollBtn:hover:not(:disabled){transform:translateY(-1px); box-shadow:0 6px 14px rgba(59,47,47,0.45)}
    #rollBtn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow:none; transform:none }

    #rollResult {
        font-weight:800; 
        display:block; 
        text-align: center;
        padding-top: 5px;
        font-size: 14px;
        color: var(--muted);
    }
    
    #resetBtn {
        padding: 10px 14px;
        font-size: 14px;
        border-radius: 10px;
        font-weight: 700;
        background: #ff7f7f; 
        color: white;
        box-shadow: 0 4px 8px rgba(255,0,0,0.15);
        border: none;
        cursor: pointer;
        transition: transform .15s, box-shadow .15s;
    }
    #resetBtn:hover:not(:disabled){transform:translateY(-1px); box-shadow:0 6px 12px rgba(255,0,0,0.25)}
    #resetBtn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow:none; transform:none }


    /* 3. ESTAD√çSTICA DE VELOCIDAD (entre Estilo y Etapa) */
    .speed-stat-position {
        background: rgba(15, 120, 200, 0.85); /* Azul */
        color: white;
        padding: 4px 10px; 
        border-radius: 8px;
        font-weight: 800;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(15, 120, 200, 0.3);
        pointer-events: all; 
        margin-right: 10px; 
    }
    
    /* Botones de + / - compactos */
    .btn-compact{
        padding:8px 10px; border-radius:10px; font-size:18px; width:40px; height:40px; 
        display:flex; align-items:center; justify-content:center; 
        box-shadow:0 2px 4px rgba(255,160,0,0.1);
        border: none;
        cursor: pointer;
        transition: transform .15s, box-shadow .15s;
    }
    .btn-compact.btn-ghost{
        background:#fff;border:1px solid rgba(0,0,0,0.1);color:var(--ink);
        box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    .btn-compact:hover:not(:disabled){transform:translateY(-1px); box-shadow:0 4px 8px rgba(255,160,0,0.25)}
    .btn-compact.btn-ghost:hover:not(:disabled){transform:translateY(-1px); box-shadow:0 4px 8px rgba(0,0,0,0.1)}
    .btn-compact:disabled { opacity: 0.6; cursor: not-allowed; box-shadow:none; transform:none }


    .log{height:100px;overflow-y:auto;background:linear-gradient(180deg,#fff,#fff7f0);padding:10px;border-radius:10px;border:1px dashed rgba(0,0,0,0.05);font-size:14px;margin-top:18px}
    .log div { margin-bottom: 4px; border-bottom: 1px dotted rgba(0,0,0,0.1); padding-bottom: 4px; font-weight:600; color:var(--muted) }
    .log div:last-child { margin-bottom: 0; border-bottom: none; }
    .log .event{color:var(--exp); font-weight:800} 

    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

    /* Mobile responsive (Ajustes menores) */
    @media (max-width:900px){
        .app { margin: 16px auto; }
        .panel{grid-template-columns:1fr; gap: 16px;}
        .list{height:38vh; min-height: 250px;}
        .sheet{height:calc(100vh - 250px); padding: 12px}
        .sprite-area-card { min-height: 300px; padding: 10px; padding-top: 80px; }
        .overlay-container { padding: 12px; }
        .compact-header { gap: 10px; }
        .stat-circle { width: 48px; height: 48px; }
        .stat-circle .num { font-size: 18px; }
        .big-sprite img { height: 90%; top: -5%; } 
        
        .top-controls-row { margin-bottom: 10px; }
        .card-exp-bar-position { max-width: 50%; margin: 0 10px; }

        /* Ocultamos el grupo vertical en m√≥vil si est√° en la esquina superior derecha*/
        .vertical-button-group { display:flex; }
        
        .speed-stat-position { margin-right: 5px; font-size: 13px; padding: 3px 8px; }

        .poke-title-card { font-size: 26px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">‚≠ê</div>
      <div class="title">Pok√©mon Adventure</div>
    </header>

    <main class="panel">
      <aside class="list">
        <div class="search">
          <input id="search" placeholder="Buscar Pok√©mon (nombre o tipo)..." />
          <select id="filter">
            <option value="all">Todos</option>
            <option value="R√°pido">‚ö° R√°pido</option>
            <option value="Ofensivo">‚öîÔ∏è Ofensivo</option>
            <option value="T√©cnico">‚≠ê T√©cnico</option>
            <option value="Fuerte">üí• Fuerte</option>
          </select>
        </div>
        <div id="listArea"></div>
      </aside>

      <section class="sheet">
        
        <div class="sprite-area-card">
          <div class="big-sprite" id="bigSprite">‚ùì</div>

          <div class="overlay-container">
            
            <div class="top-controls-row">
                
                <div class="exp-group">
                    <button id="subExp" class="btn-compact btn-ghost" disabled>‚àí</button>
                    <div class="stat-circle exp-circle" id="expCircle"><div id="expNum" class="num">0</div><small>EXP</small></div>
                    <button id="addExp" class="btn-compact" disabled>+</button>
                </div>
                
                <div class="card-exp-bar-position">
                    <div class="exp-bar-wrapper">
                        <div id="expBarProgress" class="exp-bar" style="width:0%"></div>
                    </div>
                </div>
                
                <div class="life-group">
                    <button id="subLife" class="btn-compact btn-ghost" disabled>‚àí</button>
                    <div class="stat-circle heart" id="heartLives"><div class="heart-icon">‚ù§Ô∏è</div><div id="lifeNum" class="num">0</div></div>
                    <button id="addLife" class="btn-compact" disabled>+</button>
                </div>
                
            </div>
            
            <div class="vertical-button-group">
                <button id="rollBtn" disabled>Tirar d20</button>
                <div id="rollResult"></div>
                <button id="resetBtn" disabled>Reset</button>
            </div>

            <div class="bottom-overlay">
                
                <div class="style-badge-compact">
                    <div class="left">
                        <div id="styleIcon">?</div> 
                        <div id="styleText">Estilo</div>
                    </div>
                    
                    <div id="speedStat" class="speed-stat-position" style="display:none"></div>
                    
                    <div class="level-info">Etapa <span id="levelNum">1</span></div>
                </div>
                
                <div class="style-desc" id="styleDescription" style="display:none"></div>

                <div class="poke-title-card" id="pokeName">Selecciona un Pok√©mon</div>
            </div>

          </div> 
        </div> 
        
        <div id="log" class="log"></div>

        <div style="margin-top: 15px; text-align: center;">
            <button id="installBtn" style="display:none;">Instalar App</button>
        </div>

        <footer>
          App offline (PWA) con datos Kanto 1-151. Mec√°nicas Yoshi-like.
        </footer>
      </section>
    </main>
  </div>

  <script>
    // -------------------- Data (CSV Kanto 1-151) --------------------
    const csv = `#,Name,Type 1,Type 2,Total,HP,Attack,Defense,Sp. Atk,Sp. Def,Speed,Generation,Legendary
1,Bulbasaur,Grass,Poison,318,45,49,49,65,65,45,1,False
2,Ivysaur,Grass,Poison,405,60,62,63,80,80,60,1,False
3,Venusaur,Grass,Poison,525,80,82,83,100,100,80,1,False
4,Charmander,Fire,,309,39,52,43,60,50,65,1,False
5,Charmeleon,Fire,,405,58,64,58,80,65,80,1,False
6,Charizard,Fire,Flying,534,78,84,78,109,85,100,1,False
7,Squirtle,Water,,314,44,48,65,50,64,43,1,False
8,Wartortle,Water,,405,59,63,80,65,80,58,1,False
9,Blastoise,Water,,530,79,83,100,85,105,78,1,False
10,Caterpie,Bug,,195,45,30,35,20,20,45,1,False
11,Metapod,Bug,,205,50,20,55,25,25,30,1,False
12,Butterfree,Bug,Flying,395,60,45,50,90,80,70,1,False
13,Weedle,Bug,Poison,195,40,35,30,20,20,50,1,False
14,Kakuna,Bug,Poison,205,45,25,50,25,25,35,1,False
15,Beedrill,Bug,Poison,395,65,90,40,45,80,75,1,False
16,Pidgey,Normal,Flying,251,40,45,40,35,35,56,1,False
17,Pidgeotto,Normal,Flying,349,63,60,55,50,50,71,1,False
18,Pidgeot,Normal,Flying,479,83,80,75,70,70,101,1,False
19,Rattata,Normal,,253,30,56,35,25,35,72,1,False
20,Raticate,Normal,,413,55,81,60,50,70,97,1,False
21,Spearow,Normal,Flying,262,40,60,30,31,31,70,1,False
22,Fearow,Normal,Flying,442,65,90,65,61,61,100,1,False
23,Ekans,Poison,,288,35,60,44,40,54,55,1,False
24,Arbok,Poison,,438,60,85,69,65,79,80,1,False
25,Pikachu,Electric,,320,35,55,40,50,50,90,1,False
26,Raichu,Electric,,485,60,90,55,90,80,110,1,False
27,Sandshrew,Ground,,300,50,75,85,20,30,40,1,False
28,Sandslash,Ground,,450,75,100,110,45,55,65,1,False
29,Nidoran‚ôÄ,Poison,,275,55,47,52,40,40,41,1,False
30,Nidorina,Poison,,365,70,62,67,55,55,56,1,False
31,Nidoqueen,Poison,Ground,505,90,92,87,75,85,76,1,False
32,Nidoran‚ôÇ,Poison,,273,46,57,40,40,40,50,1,False
33,Nidorino,Poison,,365,61,72,57,55,55,65,1,False
34,Nidoking,Poison,Ground,505,81,102,77,85,75,85,1,False
35,Clefairy,Fairy,,323,70,45,48,60,65,35,1,False
36,Clefable,Fairy,,483,95,70,73,95,90,60,1,False
37,Vulpix,Fire,,299,38,41,40,50,65,65,1,False
38,Ninetales,Fire,,505,73,76,75,81,100,100,1,False
39,Jigglypuff,Normal,Fairy,270,115,45,20,45,25,20,1,False
40,Wigglytuff,Normal,Fairy,435,140,70,45,85,50,45,1,False
41,Zubat,Poison,Flying,245,40,45,35,30,40,55,1,False
42,Golbat,Poison,Flying,455,75,80,70,65,75,90,1,False
43,Oddish,Grass,Poison,320,45,50,55,75,65,30,1,False
44,Gloom,Grass,Poison,395,60,65,70,85,75,40,1,False
45,Vileplume,Grass,Poison,490,75,80,85,110,90,50,1,False
46,Paras,Bug,Grass,285,35,70,55,45,55,25,1,False
47,Parasect,Bug,Grass,405,60,95,80,60,80,30,1,False
48,Venonat,Bug,Poison,305,60,55,50,40,55,45,1,False
49,Venomoth,Bug,Poison,450,70,65,60,90,75,90,1,False
50,Diglett,Ground,,265,10,55,25,35,45,95,1,False
51,Dugtrio,Ground,,405,35,80,50,50,70,120,1,False
52,Meowth,Normal,,290,40,45,35,40,40,90,1,False
53,Persian,Normal,,440,65,70,60,65,65,115,1,False
54,Psyduck,Water,,320,50,52,48,65,50,55,1,False
55,Golduck,Water,,500,80,82,78,95,80,85,1,False
56,Mankey,Fighting,,305,40,80,35,35,45,70,1,False
57,Primeape,Fighting,,455,65,105,60,60,70,95,1,False
58,Growlithe,Fire,,350,55,70,45,70,50,60,1,False
59,Arcanine,Fire,,555,90,110,80,100,80,95,1,False
60,Poliwag,Water,,300,40,50,40,40,40,90,1,False
61,Poliwhirl,Water,,385,65,65,65,50,50,90,1,False
62,Poliwrath,Water,Fighting,510,90,95,95,70,90,70,1,False
63,Abra,Psychic,,310,25,20,15,105,55,90,1,False
64,Kadabra,Psychic,,400,40,35,30,120,70,105,1,False
65,Alakazam,Psychic,,500,50,50,45,135,95,120,1,False
66,Machop,Fighting,,305,70,80,50,35,35,35,1,False
67,Machoke,Fighting,,405,80,100,70,50,60,45,1,False
68,Machamp,Fighting,,505,90,130,80,65,85,55,1,False
69,Bellsprout,Grass,Poison,300,50,75,35,70,30,40,1,False
70,Weepinbell,Grass,Poison,390,65,90,50,85,45,55,1,False
71,Victreebel,Grass,Poison,490,80,105,65,100,70,70,1,False
72,Tentacool,Water,Poison,335,40,40,35,50,100,70,1,False
73,Tentacruel,Water,Poison,515,80,70,65,80,120,100,1,False
74,Geodude,Rock,Ground,300,40,80,100,30,30,20,1,False
75,Graveler,Rock,Ground,390,55,95,115,45,45,35,1,False
76,Golem,Rock,Ground,495,80,120,130,55,65,45,1,False
77,Ponyta,Fire,,410,50,85,55,65,65,90,1,False
78,Rapidash,Fire,,500,65,100,70,80,80,105,1,False
79,Slowpoke,Water,Psychic,315,90,65,65,40,40,15,1,False
80,Slowbro,Water,Psychic,490,95,75,110,100,80,30,1,False
81,Magnemite,Electric,Steel,325,25,35,70,95,55,45,1,False
82,Magneton,Electric,Steel,465,50,60,95,120,70,70,1,False
83,Farfetch'd,Normal,Flying,352,52,65,55,58,62,60,1,False
84,Doduo,Normal,Flying,310,35,85,45,35,35,75,1,False
85,Dodrio,Normal,Flying,460,60,110,70,60,60,100,1,False
86,Seel,Water,,325,65,45,55,45,70,45,1,False
87,Dewgong,Water,Ice,475,90,70,80,70,95,70,1,False
88,Grimer,Poison,,325,80,80,50,40,50,25,1,False
89,Muk,Poison,,500,105,105,75,65,100,50,1,False
90,Shellder,Water,,305,30,65,100,45,25,40,1,False
91,Cloyster,Water,Ice,525,50,95,180,85,45,70,1,False
92,Gastly,Ghost,Poison,310,30,35,30,100,35,80,1,False
93,Haunter,Ghost,Poison,405,45,50,45,115,55,95,1,False
94,Gengar,Ghost,Poison,500,60,65,60,130,75,110,1,False
95,Onix,Rock,Ground,385,35,45,160,30,45,70,1,False
96,Drowzee,Psychic,,328,60,48,45,43,90,42,1,False
97,Hypno,Psychic,,483,85,73,70,73,115,67,1,False
98,Krabby,Water,,325,30,105,90,25,25,50,1,False
99,Kingler,Water,,475,55,130,115,50,50,75,1,False
100,Voltorb,Electric,,330,40,30,50,55,55,100,1,False
101,Electrode,Electric,,480,60,50,70,80,80,140,1,False
102,Exeggcute,Grass,Psychic,325,60,40,80,60,45,40,1,False
103,Exeggutor,Grass,Psychic,520,95,95,85,125,65,55,1,False
104,Cubone,Ground,,320,50,50,95,40,50,35,1,False
105,Marowak,Ground,,425,60,80,110,50,80,45,1,False
106,Hitmonlee,Fighting,,455,50,120,53,35,110,87,1,False
107,Hitmonchan,Fighting,,455,50,105,79,35,110,76,1,False
108,Lickitung,Normal,,385,90,55,75,60,75,30,1,False
109,Koffing,Poison,,340,40,65,95,60,45,35,1,False
110,Weezing,Poison,,490,65,90,120,85,70,60,1,False
111,Rhyhorn,Ground,Rock,345,80,85,95,30,30,25,1,False
112,Rhydon,Ground,Rock,485,105,130,120,45,45,40,1,False
113,Chansey,Normal,,450,250,5,5,35,105,50,1,False
114,Tangela,Grass,,435,65,55,115,100,40,60,1,False
115,Kangaskhan,Normal,,490,105,95,80,40,80,90,1,False
116,Horsea,Water,,295,30,40,70,70,25,60,1,False
117,Seadra,Water,,440,55,65,95,95,45,85,1,False
118,Goldeen,Water,,320,45,67,60,35,50,63,1,False
119,Seaking,Water,,450,80,92,65,65,80,68,1,False
120,Staryu,Water,,340,30,45,55,70,55,85,1,False
121,Starmie,Water,Psychic,520,60,75,85,100,85,115,1,False
122,Mr. Mime,Psychic,,460,40,45,65,100,120,90,1,False
123,Scyther,Bug,Flying,500,70,110,80,55,80,105,1,False
124,Jynx,Ice,Psychic,455,65,50,35,115,95,95,1,False
125,Electabuzz,Electric,,490,65,83,57,95,85,105,1,False
126,Magmar,Fire,,495,65,95,57,100,85,93,1,False
127,Pinsir,Bug,,500,65,125,100,55,70,85,1,False
128,Tauros,Normal,,490,75,100,95,40,70,110,1,False
129,Magikarp,Water,,200,20,10,55,15,20,80,1,False
130,Gyarados,Water,Flying,540,95,125,79,60,100,81,1,False
131,Lapras,Water,Ice,535,130,85,80,85,95,60,1,False
132,Ditto,Normal,,288,48,48,48,48,48,48,1,False
133,Eevee,Normal,,325,55,55,50,45,65,55,1,False
134,Vaporeon,Water,,525,130,65,60,110,95,65,1,False
135,Jolteon,Electric,,525,65,65,60,110,95,130,1,False
136,Flareon,Fire,,525,130,130,60,95,110,65,1,False
137,Porygon,Normal,,395,65,60,70,85,75,40,1,False
138,Omanyte,Rock,Water,355,35,40,100,90,55,35,1,False
139,Omastar,Rock,Water,495,70,60,125,115,70,55,1,False
140,Kabuto,Rock,Water,355,30,80,90,55,45,55,1,False
141,Kabutops,Rock,Water,495,60,115,105,65,70,80,1,False
142,Aerodactyl,Rock,Flying,515,80,105,65,60,75,130,1,False
143,Snorlax,Normal,,540,160,110,65,65,110,30,1,False
144,Articuno,Ice,Flying,580,90,85,100,95,125,85,1,True
145,Zapdos,Electric,Flying,580,90,90,85,125,90,100,1,True
146,Moltres,Fire,Flying,580,90,100,90,125,85,90,1,True
147,Dratini,Dragon,,300,41,64,45,50,50,50,1,False
148,Dragonair,Dragon,,420,61,84,65,70,70,70,1,False
149,Dragonite,Dragon,Flying,600,91,134,95,100,100,80,1,False
150,Mewtwo,Psychic,,680,106,110,90,154,90,130,1,True
151,Mew,Psychic,,600,100,100,100,100,100,100,1,False`;

    // -------------------- Core Functions --------------------
    function parseCSV(text){
      const lines = text.trim().split(/\n+/);
      const headers = lines[0].split(',');
      return lines.slice(1).map(l=>{const cols = l.split(','); let obj={}; headers.forEach((h,i)=>obj[h.trim()]=cols[i]); return obj});
    }

    // Mapeo de evoluciones para Kanto (solo los nombres)
    const manualEvo = {
      'Bulbasaur':['Ivysaur','Venusaur'],'Charmander':['Charmeleon','Charizard'],'Squirtle':['Wartortle','Blastoise'],
      'Caterpie':['Metapod','Butterfree'],'Weedle':['Kakuna','Beedrill'],'Pidgey':['Pidgeotto','Pidgeot'],'Rattata':['Raticate'],
      'Pikachu':['Raichu'],'Poliwag':['Poliwhirl','Poliwrath'],'Abra':['Kadabra','Alakazam'],'Machop':['Machoke','Machamp'],
      'Bellsprout':['Weepinbell','Victreebel'],'Magikarp':['Gyarados'],'Eevee':['Vaporeon','Jolteon','Flareon'],'Dratini':['Dragonair','Dragonite'],
      'Gastly':['Haunter','Gengar'],'Geodude':['Graveler','Golem'],'Oddish':['Gloom','Vileplume'],
      'Ekans':['Arbok'], 'Sandshrew':['Sandslash'], 'Mankey':['Primeape'], 'Growlithe':['Arcanine'], 
      'Seel':['Dewgong'], 'Grimer':['Muk'], 'Horsea':['Seadra'], 'Goldeen':['Seaking'],
      'Koffing':['Weezing'], 'Rhyhorn':['Rhydon'], 'Drowzee':['Hypno'], 'Krabby':['Kingler'],
      'Tentacool':['Tentacruel'], 'Ponyta':['Rapidash'], 'Slowpoke':['Slowbro'], 'Magnemite':['Magneton'],
      'Doduo':['Dodrio'], 'Shellder':['Cloyster'], 'Voltorb':['Electrode'], 'Exeggcute':['Exeggutor'],
      'Cubone':['Marowak'], 'Omanyte':['Omastar'], 'Kabuto':['Kabutops'], 'Kabutops':['Kabutops'],
      'Zubat':['Golbat'], 'Jigglypuff':['Wigglytuff'], 'Clefairy':['Clefable'], 'Meowth':['Persian'], 
      'Psyduck':['Golduck'], 'Venonat':['Venomoth'], 'Diglett':['Dugtrio'], 'Spearow':['Fearow'], 
      'Nidoran‚ôÄ':['Nidorina', 'Nidoqueen'], 'Nidoran‚ôÇ':['Nidorino', 'Nidoking'], 'Vulpix':['Ninetales'], 
      'Paras':['Parasect']
    };

    // Inicializa las estad√≠sticas (EXP, Nivel, Estilo) de cualquier Pok√©mon del CSV
    function calculateStats(row){
      const HP=+row.HP, ATK=+row.Attack, SPA=+row['Sp. Atk'], DEF=+row.Defense, SPD=+row['Sp. Def'], SPEED=+row.Speed;
      const topOff = Math.max(ATK,SPA), topDef = Math.max(DEF,SPD);
      
      // C√°lculo del coeficiente: (0.9 * HP + M√°x(Off) + M√°x(Def)) / Velocidad
      const coef = +( (0.9 * HP + topOff + topDef) / (SPEED||1) ).toFixed(2);
      let clas = ''; 

      // =================================================================
      // ALGORITMO DE BALANCE FINAL
      // =================================================================

      const name = row.Name;
      const technicalOverrideList = ['Bulbasaur', 'Ivysaur', 'Oddish', 'Paras', 'Venonat','Venusaur','Butterfree', 'Nidoqueen', 'Gloom', 'Vileplume', 'Venomoth','Tentacool'];
      const isTechnicalOverride = technicalOverrideList.includes(name);

      if (isTechnicalOverride) {
        clas = 'T√©cnico';
      }
      // 1. Clasificaci√≥n FUERTE (coef > 4.25)
      else if (coef > 4.25) { 
          clas = 'Fuerte';
      }
      // 2. Clasificaci√≥n R√ÅPIDO (Velocidad extrema)
      else if (SPEED >= 56 && coef < 2.5) {
          clas = 'R√°pido';
      }
      // 2.5. Clasificaci√≥n FUERTE (Promoci√≥n por Coeficiente Intermedio + Lento)
      else if (SPEED < 60 && coef >= 3.25) {
          clas = 'Fuerte';
      }
      // 3. Diferenciaci√≥n para el resto (coef <= 4.25 y no override)
      else { 
          if (SPEED < 68) {
              clas = 'T√©cnico';
          }
          else {
              clas = 'Ofensivo';
          }
      }

      let vidas = 0;
      if (clas === 'R√°pido') {
          vidas = 2; 
      }
      else if (clas === 'Ofensivo' || clas === 'T√©cnico') {
          vidas = 3; 
      }
      else { // clas === 'Fuerte'
          // 5 Vidas si coef > 5.20. 4 si es menor.
          vidas = (coef > 5.20) ? 5 : 4; 
          
          // --- NUEVA REGLA DE CAPADO PARA ETAPA 1 FUERTE ---
          
          // Identificamos si el Pok√©mon es una forma b√°sica que tiene al menos una evoluci√≥n posterior.
          // Si su nombre es una clave en manualEvo, es una Etapa 1 que evoluciona.
          const hasSubsequentEvolution = Object.keys(manualEvo).includes(name);

          if (hasSubsequentEvolution && vidas === 5) {
              // Si es un B√ÅSICO que evoluciona (Etapa 1), es Fuerte, y el algoritmo le dio 5, se capa a 4.
              // Esto no afecta a Snorlax o Rhydon. Afecta a Rhyhorn (5.86 -> 4), Slowpoke (7.5 -> 4), Geodude (5.5 -> 4), etc.
              vidas = 4;
          }
      }

      const poke = {
        id:+row['#'], name:row.Name, type1:row['Type 1'], type2:row['Type 2'],
        clas:clas, 
        vidas:vidas, 
        exp:0, level:1, evoThresholds:[4,10], 
        spriteId: +row['#'],
        speed: SPEED,
        coef: coef 
      };
      return poke;
    }

    // Lista de Pok√©dex con TODOS los datos base (151 filas del CSV)
    const pokedexData = parseCSV(csv);
    
    // Mapa de TODAS las estad√≠sticas de los 151 Pok√©mon por nombre para b√∫squeda r√°pida
    const allPokesMap = new Map();
    pokedexData.forEach(p => {
        allPokesMap.set(p.Name, calculateStats(p));
    });

    // Lista completa de 151 Pok√©mon para la lista izquierda
    const pokedex = pokedexData.map(row => calculateStats(row));

    // Mapa para rastrear el estado mutable: CLAVE = ID del Pok√©mon seleccionado inicialmente
    const mutableStateMapByCurrentID = new Map();

    // Estado de la Aplicaci√≥n
    const state = {
      pokedex: pokedex, 
      filtered: [],
      currentPokemon: null, 
      selectedID: null 
    };

    // -------------------- Utility Functions --------------------
    const $ = id => document.getElementById(id);

    function log(t, isEvent = false){ 
      const L=$('log'); 
      const row = document.createElement('div'); 
      row.className = isEvent ? 'event' : '';
      row.innerHTML = `[${new Date().toLocaleTimeString('es-ES').slice(0,-3)}] ${t}`; 
      L.prepend(row); 
    }

    function updateControls(enabled) {
      ['addExp', 'subExp', 'addLife', 'subLife', 'rollBtn', 'resetBtn'].forEach(id => {
        $(id).disabled = !enabled;
      });
    }

    function getBaseName(pName){
        let name = pName;
        while(Object.values(manualEvo).flat().includes(name)){
            const base = Object.keys(manualEvo).find(key => manualEvo[key].includes(name));
            if (base) name = base;
            else break;
        }
        return name;
    }
    
    function getEvoChain(baseName){
        return manualEvo[baseName] || [];
    }

    // -------------------- Game Logic --------------------
    
    function getEvoGoal(p){
      const baseName = getBaseName(p.name);
      const chain = getEvoChain(baseName);

      if (chain.length === 0) return '‚àû';

      let levelAtThisStage;

      if (p.name === baseName) {
          levelAtThisStage = 1;
      } else if (chain[0] && p.name === chain[0]) {
          levelAtThisStage = 2;
      } else if (chain[1] && p.name === chain[1]) {
          levelAtThisStage = 3;
      } else {
          return '‚àû'; 
      }
      
      if (levelAtThisStage === 1) {
          return p.evoThresholds[0] || 4; 
      } else if (levelAtThisStage === 2) {
          return p.evoThresholds[1] || 10; 
      } else {
          return '‚àû'; 
      }
    }

    function checkEvo(p){
      const goal = getEvoGoal(p);
      if(goal === '‚àû' || p.exp < goal) return; 

      p.exp = 0; 
      p.level += 1;

      const baseName = getBaseName(p.name);
      const chain = getEvoChain(baseName);

      let nextName;
      if (p.level === 2 && chain[0] && p.name === baseName) {
          nextName = chain[0];
      } else if (p.level === 3 && chain[1] && p.name === chain[0]) {
          nextName = chain[1];
      } else {
          if (p === state.currentPokemon) {
              renderSheet(p);
              log(`¬°${p.name} subi√≥ a Etapa ${p.level} y es su etapa final!`, true);
          }
          return; 
      }

      const evolvedStats = allPokesMap.get(nextName);
      if (evolvedStats) {
          p.name = evolvedStats.name; 
          p.type1 = evolvedStats.type1;
          p.type2 = evolvedStats.type2;
          p.clas = evolvedStats.clas;
          p.spriteId = evolvedStats.id; 
          p.vidas = Math.min(100, p.vidas + 1); 
          p.speed = evolvedStats.speed; 
          p.coef = evolvedStats.coef; 

          if (p === state.currentPokemon) {
              renderSheet(p);
              animateEvo();
              log(`¬°${p.name} evolucion√≥ a ${evolvedStats.name}! (Etapa ${p.level})`, true);
          }
      }
    }

    function rollD20(){ return Math.floor(Math.random()*20)+1; }
    function animateEvo(){ const big = $('bigSprite').querySelector('img'); if(big) { big.style.transform='scale(1.06)'; setTimeout(()=>big.style.transform='scale(1)',400); } }


    // -------------------- UI Functions --------------------

    async function selectPokemon(p){
      let pState = mutableStateMapByCurrentID.get(p.id);

      if (!pState) {
          // Inicializa el estado con los valores base (incluyendo la clase recalculada)
          pState = JSON.parse(JSON.stringify(p)); 

          const baseName = getBaseName(p.name);
          pState.baseName = baseName;
          
          const chain = getEvoChain(baseName);
          if (pState.name !== baseName) {
              pState.level = chain.indexOf(p.name) + 2; 
              pState.exp = 0; 
          } else {
              pState.level = 1;
              pState.exp = 0;
          }
          
          const currentBaseStats = allPokesMap.get(p.name);
          if (currentBaseStats) {
              pState.vidas = currentBaseStats.vidas;
              pState.speed = currentBaseStats.speed; 
              pState.clas = currentBaseStats.clas; // Usamos la clase del mapa que tiene el nuevo algoritmo
          }
          
          mutableStateMapByCurrentID.set(p.id, pState);
      }
      
      if (state.selectedID) {
          const prevCard = document.querySelector(`.poke-card[data-id="${state.selectedID}"]`);
          if (prevCard) prevCard.style.border = '1px solid rgba(0,0,0,0.05)';
      }
      
      state.currentPokemon = pState; 
      state.selectedID = p.id; 
      
      const currentCard = document.querySelector(`.poke-card[data-id="${state.selectedID}"]`);
      if (currentCard) currentCard.style.border = `2px solid var(--accent)`;

      renderSheet(pState); 
      updateControls(true); 

      log(`Seleccionado ${pState.name} (Etapa ${pState.level})`);
    }

    function renderSheet(p){
      const currentBaseStats = allPokesMap.get(p.name);
      // Usamos la velocidad del Pok√©mon en su etapa actual
      const pokeSpeed = currentBaseStats ? currentBaseStats.speed : p.speed;

      $('pokeName').textContent = p.name;
      $('expNum').textContent = p.exp;
      $('lifeNum').textContent = p.vidas; 
      
      // Iconos de Estilo
      $('styleIcon').textContent = p.clas==='R√°pido'?'‚ö°':(p.clas==='T√©cnico'?'‚≠ê':(p.clas==='Ofensivo'?'‚öîÔ∏è':'üí•'));
      $('styleText').textContent = p.clas;
      $('levelNum').textContent = p.level;
      
      // Mostrar la velocidad
      $('speedStat').textContent = `Velocidad: ${pokeSpeed}`;
      $('speedStat').style.display='flex'; 

      const goal = getEvoGoal(p);
      const expPercent = goal === '‚àû' ? 100 : (p.exp / goal) * 100;

      $('expBarProgress').style.width = `${Math.min(100, expPercent)}%`;

      const bigSprite = $('bigSprite');
      bigSprite.innerHTML = ''; 
      const spriteUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${p.spriteId}.png`;
      const img = document.createElement('img');
      img.src = spriteUrl;
      img.alt = p.name;
      img.onerror = () => { bigSprite.textContent = '‚ùì'; }; 
      bigSprite.appendChild(img);

      showStyleDescription(p.clas);
    }

    function renderList(list = state.pokedex){
      list.sort((a,b) => a.id - b.id);
      
      state.filtered = list;
      const listArea = $('listArea');
      listArea.innerHTML='';
      state.filtered.forEach(p=>{
        const el = document.createElement('div'); el.className='poke-card';
        el.setAttribute('data-id', p.id); 
        const spriteUrlSmall = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.id}.png`;
        const spriteHtml = `<img src="${spriteUrlSmall}" alt="${p.name}" onerror="this.outerHTML='${p.id}'"/>`;
        el.innerHTML = `<div class='mini-sprite'>${spriteHtml}</div><div class='meta'><strong>${p.id}. ${p.name}</strong><small>${p.clas} ‚Ä¢ ${p.vidas} vidas</small></div>`;
        
        el.onclick = ()=>selectPokemon(p);
        listArea.appendChild(el);
        
        if (state.selectedID === p.id) {
            el.style.border = `2px solid var(--accent)`;
        } else {
            el.style.border = '1px solid rgba(0,0,0,0.05)';
        }
      });
    }

    // Descripciones de Estilo Actualizadas con las reglas de combate finales
    function showStyleDescription(clas){
      const desc = $('styleDescription');
      desc.style.display='block';
      desc.innerHTML = '';
      
      // Obtenemos las vidas base del Pok√©mon actualmente seleccionado, asegur√°ndonos de que est√© en el estado mutable.
      const p = state.currentPokemon;
      const currentVidas = p ? p.vidas : 0;
      
      if(clas==='Fuerte'){
        desc.innerHTML = `<strong>Fuerte üí• (${currentVidas} Vidas Base)</strong><p>Golpe Potente: hace <strong>2 corazones</strong> de da√±o si en la tirada de d20 obtienes un n√∫mero <strong>mayor o igual a 14</strong> (14‚Äì20).<br><em>T√°ctica: Pok√©mon lentos pero con el m√°ximo da√±o base. Su rol es tanquear y golpear fuerte.</em></p>`;
      } else if(clas==='Ofensivo'){ 
        desc.innerHTML = `<strong>Ofensivo ‚öîÔ∏è (${currentVidas} Vidas Base)</strong><p>Da√±o Consistente: hace <strong>2 corazones</strong> de da√±o si en la tirada de d20 obtienes un n√∫mero <strong>mayor o igual a 13</strong> (13‚Äì20).<br><em>T√°ctica: La clase con mayor precisi√≥n para infligir 2 de da√±o. Atacantes principales y confiables.</em></p>`;
      } else if(clas==='T√©cnico'){
        desc.innerHTML = `<strong>T√©cnico ‚≠ê (${currentVidas} Vidas Base)</strong><p>Precisi√≥n y Control: hace <strong>1 coraz√≥n</strong> de da√±o si sacas <strong>11 o m√°s</strong> en d20. Adem√°s, si obtienes <strong>1</strong> o <strong>20</strong>, se aplica un <strong>problema de estado</strong> (Envenenan, Paraliza o Queman).<p><div style="margin-top:8px;font-size:13px;color:var(--muted)">T√°ctica: Se centran en utilidad y control de campo.</div>`;
      } else { // R√°pido
        desc.innerHTML = `<strong>R√°pido ‚ö° (${currentVidas} Vidas Base)</strong><p>Velocidad y Evasi√≥n: hace <strong>1 coraz√≥n</strong> de da√±o si sacas <strong>8 o m√°s</strong> en d20. Si sacas <strong>19-20</strong>, el golpe es **Critico**.</p><div style="margin-top:8px;font-size:13px;color:var(--muted)">Habilidad Pok√©mon:Evasion (El rival lanza una moneda si sale sello falla el ataque).</div>`;
      }
    }

    // -------------------- Event Handlers --------------------

    function handleSearchAndFilter(){
      const q=$('search').value.toLowerCase();
      const v=$('filter').value;
      let list = state.pokedex.filter(p=>
        p.name.toLowerCase().includes(q) ||
        (p.type1 && p.type1.toLowerCase().includes(q)) ||
        (p.type2 && p.type2.toLowerCase().includes(q))
      );
      if(v!=='all') list = list.filter(p=>p.clas===v);
      renderList(list);
    }
    $('search').addEventListener('input', handleSearchAndFilter);
    $('filter').addEventListener('change', handleSearchAndFilter);

    $('addExp').onclick = ()=>{
      const p=state.currentPokemon; if(!p) return;
      p.exp += 1;
      checkEvo(p);
      renderSheet(p);
      saveAll();
    }
    $('subExp').onclick = ()=>{
      const p=state.currentPokemon; if(!p) return;
      p.exp = Math.max(0,p.exp-1);
      renderSheet(p);
      saveAll();
    }
    $('addLife').onclick = ()=>{
      const p=state.currentPokemon; if(!p) return;
      p.vidas = Math.min(100,p.vidas+1);
      renderSheet(p);
      saveAll();
    }
    $('subLife').onclick = ()=>{
      const p=state.currentPokemon; if(!p) return;
      p.vidas = Math.max(0,p.vidas-1);
      renderSheet(p);
      saveAll();
    }
    
    // FUNCI√ìN CR√çTICA: Reseteo (Rojo)
    $('resetBtn').onclick = ()=>{
      const p=state.currentPokemon; if(!p) return;
      
      const initialVisual = state.pokedex.find(x => x.id === state.selectedID); 
      
      if (initialVisual) {
        
        p.exp = 0;
        
        const baseStats = allPokesMap.get(initialVisual.name);
        p.vidas = baseStats.vidas; 
        
        p.name = initialVisual.name;
        p.clas = initialVisual.clas;
        p.spriteId = initialVisual.id; 
        
        const baseName = getBaseName(initialVisual.name);
        const chain = getEvoChain(baseName);
        
        let calculatedLevel = 1;
        if (chain.includes(initialVisual.name)) {
            calculatedLevel = chain.indexOf(initialVisual.name) + 2; 
        } else if (initialVisual.name === baseName) {
            calculatedLevel = 1;
        }

        p.level = calculatedLevel;

        renderSheet(p);
        renderList(); 
        saveAll();
        log(`Reset completado: ${initialVisual.name} restaurado a Etapa ${p.level} (EXP 0/${getEvoGoal(p)}).`, true);
      }
    }

    // FUNCI√ìN CR√çTICA: Dado (Negro) - L√≥gica de acierto con las nuevas reglas
    $('rollBtn').onclick = ()=>{
      const p=state.currentPokemon; if(!p) return;
      const r=rollD20();
      $('rollResult').textContent = `Resultado: d20 = ${r}`;

      const clas = p.clas;

      let logMsg = `Tirada ${r} ‚Üí ${clas}: `;
      
      let resultText = "No acierta."; 

      // L√≥gica de acierto y efectos seg√∫n la clase
      if(clas==='Fuerte'){
        if(r>=14){ // Fuerte: >= 14 para 2 da√±o
          resultText = `Resultado de **Fuerte**: ¬°Acierta! (2 corazones)`;
        } else {
          resultText = `Resultado de **Fuerte**: Falla (necesita 14+)`;
        }
      } else if(clas==='Ofensivo'){ 
        if(r>=13){ // Ofensivo: >= 13 para 2 da√±o
          resultText = `Resultado de **Ofensivo**: ¬°Acierta! (2 corazones)`;
        } else {
          resultText = `Resultado de **Ofensivo**: Falla (necesita 13+)`;
        }
      } else if(clas==='T√©cnico'){
        if(r>=11){ // T√©cnico: >= 11 para 1 da√±o
          resultText = `Resultado de **T√©cnico**: ¬°Acierta! (1 coraz√≥n)`;
        } else {
          resultText = `Resultado de **T√©cnico**: Falla (necesita 11+)`;
        }
        if(r===1 || r===20){
          resultText += ` | ¬°Problema de estado aplicable!`;
        }
      } else { // R√°pido
        if(r>=8){ // R√°pido: >= 8 para 1 da√±o
          resultText = `Resultado de **R√°pido**: ¬°Acierta! (1 coraz√≥n)`;
        } else {
          resultText = `Resultado de **R√°pido**: Falla (necesita 8+)`;
        }
        if(r===20){
          resultText += ` | ¬°Paraliza garantizado!`;
        }
      }
      
      let isHit = (clas === 'R√°pido' && r >= 8) || 
                  (clas === 'T√©cnico' && r >= 11) || 
                  (clas === 'Ofensivo' && r >= 13) || 
                  (clas === 'Fuerte' && r >= 14);

      log(`${logMsg}${resultText}`, isHit); 

      saveAll(); 
    };

    // -------------------- Persistence (localStorage) --------------------
    function saveAll(){
      const saveData = Array.from(mutableStateMapByCurrentID.values()).map(p=>({
        id:p.id, 
        name:p.name, 
        exp:p.exp,
        level:p.level,
        vidas:p.vidas,
        spriteId: p.spriteId,
        baseName: p.baseName,
        speed: p.speed 
      }));
      localStorage.setItem('pokestate_151_dynamic', JSON.stringify(saveData));
      localStorage.setItem('selectedPokeId_151_dynamic', state.selectedID);
    }

    // Carga de Datos
    function loadAll(){
      try{
        const raw = JSON.parse(localStorage.getItem('pokestate_151_dynamic')||'[]');
        
        raw.forEach(r=>{
          const initialStats = state.pokedex.find(x => x.id === r.id);
          if(!initialStats) return;

          // Re-calculamos las stats para asegurar que la clase se actualice con la nueva l√≥gica
          const updatedStats = allPokesMap.get(r.name) || initialStats;

          const pState = {
            id: r.id,
            name: r.name,
            exp: r.exp,
            level: r.level,
            vidas: r.vidas,
            spriteId: r.spriteId,
            baseName: r.baseName,
            // Tomamos la clase y velocidad recalculadas de la tabla base actualizada
            clas: updatedStats.clas,
            evoThresholds: [4, 10],
            speed: updatedStats.speed
          };
          mutableStateMapByCurrentID.set(r.id, pState);
        });

        const selectedId = localStorage.getItem('selectedPokeId_151_dynamic');
        if (selectedId) {
            const selectedPoke = state.pokedex.find(p => p.id === parseInt(selectedId));
            if (selectedPoke) {
                // Usamos el ID del Pok√©mon base para cargarlo, aunque su estado mutable ya est√© cargado
                selectPokemon(selectedPoke);
            }
        }
        
        renderList(); 

      }catch(e){
        console.error("Error al cargar estado:", e);
        // En caso de error de carga (p. ej. datos corruptos), limpiamos el storage y recargamos
        localStorage.removeItem('pokestate_151_dynamic');
        loadAll(); 
      }
    }

    // Auto-guardado
    setInterval(saveAll, 5000);

    // -------------------- PWA Setup --------------------
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $('installBtn').style.display='inline-block';
    });

    $('installBtn').onclick = async ()=>{
      if(deferredPrompt){
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        if(choice.outcome==='accepted') log('App instalada!', true);
        deferredPrompt=null;
        $('installBtn').style.display='none';
      } else {
        alert('Instalaci√≥n disponible desde el men√∫ del navegador (Agregar a pantalla inicio)');
      }
    };

    // service worker simple for PWA offline capabilities (no changes needed)
    const swCode = `self.addEventListener('install', e=>{self.skipWaiting();});self.addEventListener('activate', e=>{clients.claim();});self.addEventListener('fetch', e=>{e.respondWith(fetch(e.request).catch(e=>new Response(null)));});`;
    const swBlob = new Blob([swCode], {type:'application/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register(swUrl).catch(e=>console.warn('Registro de Service Worker fallido:', e));
    }

    // manifest link (no changes needed)
    const manifest = {name:'Pok√©mon Tracker (privado)',short_name:'PokeTrack',start_url:'.',display:'standalone',background_color:'#f6efe0',theme_color:'#9b59b6', icons: [
        {src:'./icon-192.png',sizes:'192x192',type:'image/png'},
        {src:'./icon-512.png',sizes:'512x512',type:'image/png',purpose:'any maskable'}
    ]};
    const manBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const manUrl = URL.createObjectURL(manBlob);
    const link = document.createElement('link'); link.rel='manifest'; link.href = manUrl; document.head.appendChild(link);

    // -------------------- Initialisation --------------------
    loadAll();

    if (!state.currentPokemon) {
        updateControls(false);
        $('styleDescription').style.display='block';
        $('styleDescription').innerHTML = '<strong>Bienvenido</strong><p style="margin-top:6px">Selecciona un Pok√©mon de la lista (hay 151) para comenzar a hacer el seguimiento de su EXP, vidas y simular tiradas de ataque con el dado d20.</p>';
    }
  </script>
</body>
</html>
